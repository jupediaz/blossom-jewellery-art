generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── AUTH ───────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  role          UserRole  @default(CUSTOMER)
  emailVerified DateTime?
  image         String?
  phone         String?
  locale        String    @default("en")
  currency      String    @default("EUR")

  accounts     Account[]
  sessions     Session[]
  orders       Order[]
  addresses    Address[]
  cartSessions  CartSession[]
  wishlists     Wishlist[]
  imageSessions ImageGenerationSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  ADMIN
  PRODUCT_MANAGER
  CUSTOMER
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── INVENTORY ──────────────────────────────────

model Inventory {
  id                String  @id @default(cuid())
  sanityProductId   String
  sanityVariantKey  String?
  sku               String? @unique
  quantityTotal     Int     @default(0)
  quantityReserved  Int     @default(0)
  quantitySold      Int     @default(0)
  lowStockThreshold Int     @default(3)
  trackInventory    Boolean @default(true)

  stockMovements StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sanityProductId, sanityVariantKey])
  @@index([sanityProductId])
}

model StockMovement {
  id          String       @id @default(cuid())
  inventoryId String
  type        MovementType
  quantity    Int
  reason      String?
  orderId     String?
  inventory   Inventory    @relation(fields: [inventoryId], references: [id])

  createdAt DateTime @default(now())
}

enum MovementType {
  RESTOCK
  SALE
  RESERVATION
  RELEASE
  ADJUSTMENT
  RETURN
}

// ─── ORDERS ─────────────────────────────────────

model Order {
  id                  String        @id @default(cuid())
  orderNumber         String        @unique
  customerId          String?
  customer            User?         @relation(fields: [customerId], references: [id])

  guestEmail String?
  guestName  String?

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  stripeSessionId     String? @unique
  stripePaymentIntent String?

  subtotal       Decimal @db.Decimal(10, 2)
  shippingCost   Decimal @db.Decimal(10, 2) @default(0)
  taxAmount      Decimal @db.Decimal(10, 2) @default(0)
  discountAmount Decimal @db.Decimal(10, 2) @default(0)
  total          Decimal @db.Decimal(10, 2)
  currency       String  @default("EUR")

  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  shippingAddress Json
  billingAddress  Json?

  shippingMethodId String?
  shippingMethod   ShippingMethod? @relation(fields: [shippingMethodId], references: [id])
  trackingNumber   String?
  carrier          String?
  shippedAt        DateTime?
  deliveredAt      DateTime?

  customerNote String?
  internalNote String?

  items         OrderItem[]
  statusHistory OrderStatusHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model OrderItem {
  id              String @id @default(cuid())
  orderId         String
  order           Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  sanityProductId String
  variantName     String?

  productName  String
  productImage String?
  unitPrice    Decimal @db.Decimal(10, 2)
  quantity     Int
  totalPrice   Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
}

model OrderStatusHistory {
  id      String      @id @default(cuid())
  orderId String
  order   Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status  OrderStatus
  note    String?

  createdAt DateTime @default(now())
}

// ─── COUPONS ────────────────────────────────────

model Coupon {
  id                   String     @id @default(cuid())
  code                 String     @unique
  type                 CouponType
  value                Decimal    @db.Decimal(10, 2)
  minOrderValue        Decimal?   @db.Decimal(10, 2)
  maxDiscountAmount    Decimal?   @db.Decimal(10, 2)
  maxUses              Int?
  maxUsesPerCustomer   Int        @default(1)
  currentUses          Int        @default(0)

  validFrom  DateTime
  validUntil DateTime?
  isActive   Boolean @default(true)

  applicableProducts    String[]
  applicableCollections String[]

  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// ─── CART SESSIONS ──────────────────────────────

model CartSession {
  id           String @id @default(cuid())
  sessionToken String @unique @default(cuid())
  customerId   String?
  customer     User?  @relation(fields: [customerId], references: [id])

  items    Json
  subtotal Decimal @db.Decimal(10, 2) @default(0)
  currency String  @default("EUR")
  locale   String  @default("en")

  lastActivityAt    DateTime  @default(now())
  abandonedAt       DateTime?
  recoveryEmailSent DateTime?
  recoveredAt       DateTime?
  convertedOrderId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([abandonedAt])
}

// ─── SHIPPING ───────────────────────────────────

model ShippingZone {
  id                    String   @id @default(cuid())
  name                  String
  countries             String[]
  freeShippingThreshold Decimal? @db.Decimal(10, 2)
  isActive              Boolean  @default(true)

  methods ShippingMethod[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ShippingMethod {
  id               String       @id @default(cuid())
  zoneId           String
  zone             ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  name             String
  rate             Decimal @db.Decimal(10, 2)
  estimatedDaysMin Int
  estimatedDaysMax Int
  isActive         Boolean @default(true)

  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── OFFERS / FLASH SALES ───────────────────────

model Offer {
  id            String     @id @default(cuid())
  name          String
  type          OfferType
  discountType  CouponType
  discountValue Decimal    @db.Decimal(10, 2)

  applicableProducts    String[]
  applicableCollections String[]
  applyToAll            Boolean @default(false)

  validFrom  DateTime
  validUntil DateTime
  isActive   Boolean @default(true)

  bannerText String?
  badgeText  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum OfferType {
  FLASH_SALE
  LAUNCH_OFFER
  SEASONAL
  COLLECTION_SALE
  CLEARANCE
}

// ─── WISHLISTS ──────────────────────────────────

model Wishlist {
  id              String  @id @default(cuid())
  userId          String
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sanityProductId String
  variantName     String?

  createdAt DateTime @default(now())

  @@unique([userId, sanityProductId, variantName])
}

// ─── ADDRESSES ──────────────────────────────────

model Address {
  id         String  @id @default(cuid())
  userId     String
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  label      String?
  firstName  String
  lastName   String
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String
  country    String
  phone      String?
  isDefault  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── NEWSLETTER ─────────────────────────────────

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  locale    String   @default("en")
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── EMAIL LOG ──────────────────────────────────

model EmailLog {
  id       String    @id @default(cuid())
  to       String
  type     EmailType
  subject  String
  resendId String?
  status   String    @default("sent")
  metadata Json?

  createdAt DateTime @default(now())
}

enum EmailType {
  ORDER_CONFIRMATION
  SHIPPING_NOTIFICATION
  DELIVERY_CONFIRMATION
  CART_RECOVERY_1H
  CART_RECOVERY_24H
  CART_RECOVERY_48H
  WELCOME
  PASSWORD_RESET
  NEW_COLLECTION
  BACK_IN_STOCK
  REFUND_CONFIRMATION
}

// ─── AI IMAGE STUDIO ───────────────────────────

model BrandModelProfile {
  id              String   @id @default(cuid())
  name            String   @default("Ola")
  referenceImages Json     @default("[]") // Array of {path, type, filename}
  isActive        Boolean  @default(true)
  notes           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GeneratedImage {
  id                   String              @id @default(cuid())
  prompt               String
  mode                 ImageGenerationMode
  modelUsed            String
  imagePath            String
  thumbnailPath        String?
  dimensions           Json?               // {width, height}
  tags                 String[]
  linkedProductId      String?
  linkedCollectionSlug String?
  isFavorite           Boolean             @default(false)
  sessionId            String?
  session              ImageGenerationSession? @relation(fields: [sessionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mode])
  @@index([linkedProductId])
  @@index([isFavorite])
  @@index([createdAt])
}

model ImageGenerationSession {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  mode            ImageGenerationMode
  prompt          String
  referenceImages Json             @default("[]")
  modelUsed       String
  status          GenerationStatus @default(PENDING)
  resultCount     Int              @default(0)
  errorMessage    String?
  durationMs      Int?

  images GeneratedImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum ImageGenerationMode {
  SCENE
  ENHANCE
  COMPOSE
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
